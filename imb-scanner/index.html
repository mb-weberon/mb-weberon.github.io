<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMB Scanner v2.9</title>
    <style>
        :root { --accent: #00ff00; }
        body { 
            font-family: system-ui, sans-serif; margin: 0; background: #000; color: var(--accent); 
            overflow: hidden; height: 100dvh; display: flex; flex-direction: column; 
        }
        
        #camera-container { 
            position: relative; flex: 1 1 auto; overflow: hidden; touch-action: none; 
            z-index: 1; background: #111; width: 100%;
        }
        
        video, #static-frame { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #static-frame { display: none; z-index: 2; }
        
        #results-area { 
            background: rgba(15, 15, 15, 0.98); padding: 10px 15px; border-top: 1px solid #333; 
            z-index: 10; flex-shrink: 0; padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }

        .status-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }

        #fadt-text { 
            font-family: 'Courier New', monospace; font-size: clamp(14px, 3vh, 2.5vw); 
            color: #fff; background: #000; padding: 12px 5px; border-radius: 6px; 
            letter-spacing: 1px; text-align: center; border: 1px solid #444; 
            white-space: nowrap; overflow-x: auto; width: 100%; box-sizing: border-box; margin-bottom: 10px;
        }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        button { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 12px 5px; font-size: 0.75rem; text-transform: uppercase; }
        
        #process-btn { background: #0066ff; color: white; }
        #reset-btn { background: #333; color: #aaa; border: 1px solid #444; }
        #decode-btn { background: #008000; color: white; }

        /* Modal Overlay */
        #modal-overlay { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; 
        }
        #modal-content { 
            background: #1a1a1a; width: 85%; padding: 20px; border-radius: 12px; 
            border: 1px solid var(--accent); color: white; box-shadow: 0 0 20px rgba(0,255,0,0.2);
        }
        .data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .data-label { color: #aaa; }
        .data-val { color: var(--accent); font-family: monospace; font-weight: bold; }
        .close-btn { background: var(--accent); color: #000; width: 100%; margin-top: 15px; padding: 12px; }

        @media (orientation: landscape) {
            #fadt-text { padding: 6px 5px; margin-bottom: 6px; font-size: 5vh; }
            button { padding: 8px 2px; font-size: 0.65rem; }
        }
    </style>
</head>
<body>

    <div id="camera-container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="static-frame"></canvas>
    </div>
    
    <div id="results-area">
        <div class="status-row">
            <div id="status">v2.9 | Tap to Capture</div>
        </div>
        
        <div id="fadt-text">---</div>

        <div class="btn-grid">
            <button id="process-btn" onclick="processFADT()">Process</button>
            <button id="reset-btn" onclick="resetScanner()">Reset</button>
            <button id="decode-btn" onclick="decodeSelection()">Scan/Align</button>
        </div>
    </div>

    <div id="modal-overlay" onclick="this.style.display='none'">
        <div id="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0; color:var(--accent)">USPS IMB Data</h3>
            <div id="modal-body"></div>
            <button class="close-btn" onclick="document.getElementById('modal-overlay').style.display='none'">DONE</button>
        </div>
    </div>

<script>
    const video = document.getElementById('video');
    const staticCanvas = document.getElementById('static-frame');
    const fadtDisplay = document.getElementById('fadt-text');
    const statusText = document.getElementById('status');
    let isFrozen = false, cleanImageBuffer = null;
    let p1 = {x:0, y:0}, p2 = {x:0, y:0}, activeHandle = null;

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js?v=2.9');

    async function startCamera() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
            });
            video.srcObject = s;
        } catch (err) {
            statusText.innerText = "Camera Error: " + err.name;
        }
    }

    document.getElementById('camera-container').addEventListener('pointerdown', (e) => {
        if (!isFrozen) { captureFrame(); return; }

        const rect = staticCanvas.getBoundingClientRect();
        const mX = (e.clientX - rect.left) * (staticCanvas.width / rect.width);
        const mY = (e.clientY - rect.top) * (staticCanvas.height / rect.height);

        // Nearest Neighbor Handle Selection
        const distP1 = Math.hypot(mX - p1.x, mY - p1.y);
        const distP2 = Math.hypot(mX - p2.x, mY - p2.y);
        const hitThreshold = 70 * (staticCanvas.width / rect.width);

        if (distP1 < hitThreshold || distP2 < hitThreshold) {
            activeHandle = (distP1 < distP2) ? 1 : 2;
        } else {
            p1 = {x: mX, y: mY}; p2 = {x: mX, y: mY};
            activeHandle = 2;
        }
    });

    window.addEventListener('pointermove', (e) => {
        if (!activeHandle) return;
        const rect = staticCanvas.getBoundingClientRect();
        const nX = (e.clientX - rect.left) * (staticCanvas.width / rect.width);
        const nY = (e.clientY - rect.top) * (staticCanvas.height / rect.height);
        if (activeHandle === 1) p1 = {x:nX, y:nY}; else p2 = {x:nX, y:nY};
        drawInterface();
    });

    window.addEventListener('pointerup', () => { 
        if(activeHandle) decodeSelection(); 
        activeHandle = null; 
    });

    function captureFrame() {
        staticCanvas.width = video.videoWidth; 
        staticCanvas.height = video.videoHeight;
        const ctx = staticCanvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        cleanImageBuffer = ctx.getImageData(0, 0, staticCanvas.width, staticCanvas.height);
        staticCanvas.style.display = 'block'; 
        isFrozen = true;
        autoSeedBarcode();
        drawInterface();
        decodeSelection();
    }

    function autoSeedBarcode() {
        const data = cleanImageBuffer.data, W = staticCanvas.width, H = staticCanvas.height;
        let bestY = H / 2, maxTrans = 0;
        for (let y = Math.floor(H*0.2); y < H*0.8; y += 20) {
            let t = 0; 
            for (let x = Math.floor(W*0.2); x < W*0.8; x += 4) { 
                if(data[(y*W+x)*4] < 100) t++; 
            }
            if (t > maxTrans) { maxTrans = t; bestY = y; }
        }
        p1 = { x: W * 0.15, y: bestY }; p2 = { x: W * 0.85, y: bestY };
    }

    function drawInterface() {
        const ctx = staticCanvas.getContext('2d');
        ctx.putImageData(cleanImageBuffer, 0, 0);
        const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x), dist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
        const boxH = staticCanvas.height * 0.08;
        
        ctx.save(); 
        ctx.translate(p1.x, p1.y); 
        ctx.rotate(angle);
        ctx.strokeStyle = "rgba(255, 0, 0, 0.4)"; ctx.lineWidth = 2;
        ctx.strokeRect(0, -boxH/2, dist, boxH);
        ctx.strokeStyle = "#00ff00"; ctx.lineWidth = 1;
        for (let i = 1; i < 7; i++) {
            let ly = -boxH/2 + (i * (boxH/7));
            ctx.beginPath(); ctx.moveTo(0, ly); ctx.lineTo(dist, ly); ctx.stroke();
        }
        ctx.restore();
        
        // Visual Handles
        [p1, p2].forEach(p => {
            ctx.fillStyle = "white"; ctx.strokeStyle = "#00ff00"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.arc(p.x, p.y, 25, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        });
    }

    function decodeSelection() {
        const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x), dist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
        const boxH = staticCanvas.height * 0.08, stripH = boxH / 7, W = staticCanvas.width, data = cleanImageBuffer.data;
        
        let bars = [], inB = false, tS = 0;
        for (let i = 0; i < dist; i++) {
            const px = Math.floor(p1.x + Math.cos(angle) * i), py = Math.floor(p1.y + Math.sin(angle) * i);
            const isInk = data[(py * W + px) * 4] < 115;
            if (isInk && !inB) { inB = true; tS = i; }
            else if (!isInk && inB) { inB = false; if (i - tS > 1) bars.push({m: (tS+i)/2}); }
        }

        const fadt = bars.map(b => {
            let z = new Array(7).fill(false);
            for (let s = 0; s < 7; s++) {
                const off = (-boxH/2 + (s * stripH)) + (stripH/2);
                const px = Math.floor(p1.x + Math.cos(angle)*b.m - Math.sin(angle)*off);
                const py = Math.floor(p1.y + Math.sin(angle)*b.m + Math.cos(angle)*off);
                if (data[(py * W + px) * 4] < 115) z[s] = true;
            }
            const A = z[0]||z[1], D = z[5]||z[6];
            return A && D ? 'F' : A ? 'A' : D ? 'D' : 'T';
        }).join('');

        fadtDisplay.innerText = fadt || "---";
        statusText.innerText = `v2.9 | ${fadt.length} Bars`;
        statusText.style.color = fadt.length === 65 ? "#00ff00" : "#ff4444";
    }

    function processFADT() {
        const fadt = fadtDisplay.innerText;
        if (fadt.length !== 65) { alert("Need exactly 65 bars."); return; }
        
        // Placeholder for the 102-bit conversion results
        const mockResults = [
            ["Barcode ID", fadt.substring(0, 2)],
            ["Service Type", "Pending Analysis"],
            ["Mailer ID", "Calculating..."],
            ["Serial", "Reading..."],
            ["Routing ZIP", "11-Digit Search"]
        ];

        let html = '';
        mockResults.forEach(([l, v]) => {
            html += `<div class="data-row"><span class="data-label">${l}</span><span class="data-val">${v}</span></div>`;
        });
        
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function resetScanner() {
        staticCanvas.style.display = 'none'; isFrozen = false;
        fadtDisplay.innerText = "---"; statusText.innerText = "v2.9 | Ready";
    }
    window.addEventListener('load', startCamera);
</script>
</body>
</html>