<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMB Scanner v3.1</title>
    <style>
        :root { --accent: #00ff00; }
        body { font-family: system-ui, sans-serif; margin: 0; background: #000; color: var(--accent); overflow: hidden; height: 100dvh; display: flex; flex-direction: column; }
        #camera-container { position: relative; flex: 1 1 auto; overflow: hidden; touch-action: none; background: #111; }
        video, #static-frame { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #static-frame { display: none; z-index: 2; }
        #results-area { background: rgba(15,15,15,0.98); padding: 10px 15px; border-top: 1px solid #333; z-index: 10; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        #fadt-text { font-family: 'Courier New', monospace; font-size: clamp(14px, 3vh, 2.5vw); color: #fff; background: #000; padding: 12px 5px; border-radius: 6px; letter-spacing: 1px; text-align: center; border: 1px solid #444; width: 100%; box-sizing: border-box; margin-bottom: 10px; overflow-x: auto; white-space: nowrap; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        button { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 12px 5px; font-size: 0.75rem; text-transform: uppercase; }
        #process-btn { background: #0066ff; color: white; }
        #reset-btn { background: #333; color: #aaa; border: 1px solid #444; }
        #decode-btn { background: #008000; color: white; }
        #modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; }
        #modal-content { background: #1a1a1a; width: 85%; padding: 20px; border-radius: 12px; border: 1px solid var(--accent); color: white; }
        .data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .data-label { color: #aaa; }
        .data-val { color: var(--accent); font-family: monospace; font-weight: bold; }
        .close-btn { background: var(--accent); color: #000; width: 100%; margin-top: 15px; padding: 12px; }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="static-frame"></canvas>
    </div>
    <div id="results-area">
        <div class="status-row"><div id="status">v3.1 | Professional Decoder</div></div>
        <div id="fadt-text">---</div>
        <div class="btn-grid">
            <button id="process-btn" onclick="processFADT()">Process</button>
            <button id="reset-btn" onclick="resetScanner()">Reset</button>
            <button id="decode-btn" onclick="decodeSelection()">Scan/Align</button>
        </div>
    </div>
    <div id="modal-overlay" onclick="this.style.display='none'">
        <div id="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0; color:var(--accent)">IMB Results</h3>
            <div id="modal-body"></div>
            <button class="close-btn" onclick="document.getElementById('modal-overlay').style.display='none'">CLOSE</button>
        </div>
    </div>

<script>
    // --- USPS CORE LOGIC (Extracted from provided HTML) ---
    const desc_char=[7,1,9,5,8,0,2,4,6,3,5,8,9,7,3,0,6,1,7,4,6,8,9,2,5,1,7,5,4,3,8,7,6,0,2,5,4,9,3,0,1,6,8,2,0,4,5,9,6,7,5,2,6,3,8,5,1,9,8,7,4,0,2,6,3],desc_bit=[4,1024,4096,32,512,2,32,16,8,512,2048,32,1024,2,64,8,16,2,1024,1,4,2048,256,64,2,4096,8,256,64,16,16,2048,1,64,2,512,2048,32,8,128,8,1024,128,2048,256,4,1024,8,32,256,1,8,4096,2048,256,16,32,2,8,1,128,4096,512,256,1024],asc_char=[4,0,2,6,3,5,1,9,8,7,1,2,0,6,4,8,2,9,5,3,0,1,3,7,4,6,8,9,2,0,5,1,9,4,3,8,6,7,1,2,4,3,9,5,7,8,3,0,2,1,4,0,9,1,7,0,2,4,6,3,7,1,9,5,8],asc_bit=[8,1,256,2048,2,4096,256,2048,1024,64,16,4096,4,128,512,64,128,512,4,256,16,1,4096,128,1024,512,1,128,1024,32,128,512,64,256,4,4096,2,16,4,1,2,32,16,64,4096,2,1,512,16,128,32,1024,4,64,512,2048,4,4096,64,128,32,2048,1,8,4];
    let encode_table=new Array(1365),decode_table=new Array(8192),fcs_table=new Array(8192);
    function build_codewords(bits,low,hi){for(let fwd=0;fwd<8192;fwd++){let pop=0,rev=0,tmp=fwd;for(let b=0;b<13;b++){pop+=tmp&1;rev=(rev<<1)|(tmp&1);tmp>>=1}if(pop!=bits)continue;if(fwd==rev){encode_table[hi]=fwd;decode_table[fwd]=hi;decode_table[fwd^8191]=hi;fcs_table[fwd]=0;fcs_table[fwd^8191]=1;hi--}else if(fwd<rev){encode_table[low]=fwd;decode_table[fwd]=low;decode_table[fwd^8191]=low;fcs_table[fwd]=0;fcs_table[fwd^8191]=1;low++;encode_table[low]=rev;decode_table[rev]=low;decode_table[rev^8191]=low;fcs_table[rev]=0;fcs_table[rev^8191]=1;low++}}}
    build_codewords(5,0,1286);build_codewords(2,1287,1364);
    function muladd(b,m,a){let add=a;for(let n=b.length-1;n>=0;n--){let x=b[n]*m+add;add=x>>8;b[n]=x&0xff}}
    function divmod(b,d){let mod=0;for(let n=0;n<b.length;n++){let x=b[n]+(mod<<8);b[n]=Math.floor(x/d);mod=x-b[n]*d}return mod}
    function calcfcs(b){let f=0x5a8;for(let n=0;n<b.length;n++){f^=b[n]<<3;for(let bit=0;bit<8;bit++){f<<=1;if(f&0x800)f^=0xf35}}return f&0x7ff}

    function decode_chars_to_info(barcode) {
        let chars = [0,0,0,0,0,0,0,0,0,0];
        for (let n=0;n<65;n++) {
            let c=barcode.charAt(n);
            if(c==='D'||c==='F')chars[desc_char[n]]|=desc_bit[n];
            if(c==='A'||c==='F')chars[asc_char[n]]|=asc_bit[n];
        }
        let cw=new Array(10), fcs=0;
        for (let n=0;n<10;n++){
            cw[n]=decode_table[chars[n]];
            if(cw[n]===undefined) return {message:"Invalid Codeword"};
            fcs|=fcs_table[chars[n]]<<n;
        }
        if(cw[9]&1) return {message:"Upside Down?"};
        cw[9]>>=1; if(cw[0]>658){cw[0]-=659; fcs|=1<<10;}
        let bytes=[0,0,0,0,0,0,0,0,0,0,0,0,cw[0]];
        for(let n=1;n<9;n++) muladd(bytes,1365,cw[n]);
        muladd(bytes,636,cw[9]);
        if(calcfcs(bytes)!==fcs) return {message:"FCS Check Failed"};
        let track=new Array(20);
        for(let n=19;n>=2;n--) track[n]=divmod(bytes,10);
        track[1]=divmod(bytes,5); track[0]=divmod(bytes,10);
        let route=[], pos=11;
        for(let sz of [5,4,2]){ if(bytes.some(x=>x!==0)){ for(let n=0;n<sz;n++) route.unshift(divmod(bytes,10)); } }
        return {
            barcode_id: track.slice(0,2).join(''),
            service_type: track.slice(2,5).join(''),
            mailer_id: (track[5]==9) ? track.slice(5,14).join('') : track.slice(5,11).join(''),
            serial_num: (track[5]==9) ? track.slice(14,20).join('') : track.slice(11,20).join(''),
            routing: route.join('') || "None"
        };
    }

    // --- CAMERA & UI LOGIC ---
    const v=document.getElementById('video'),sc=document.getElementById('static-frame'),fd=document.getElementById('fadt-text'),st=document.getElementById('status');
    let isF=false,buf=null,p1={x:0,y:0},p2={x:0,y:0},aH=null;
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js?v=3.1');
    async function start(){ try{v.srcObject=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280}}});}catch(e){st.innerText="Camera Error";}}
    
    document.getElementById('camera-container').addEventListener('pointerdown', (e) => {
        if(!isF){cap();return;}
        const r=sc.getBoundingClientRect(),mx=(e.clientX-r.left)*(sc.width/r.width),my=(e.clientY-r.top)*(sc.height/r.height);
        const d1=Math.hypot(mx-p1.x,my-p1.y),d2=Math.hypot(mx-p2.x,my-p2.y),th=70*(sc.width/r.width);
        if(d1<th||d2<th)aH=d1<d2?1:2; else{p1={x:mx,y:my};p2={x:mx,y:my};aH=2;}
    });
    window.addEventListener('pointermove',(e)=>{if(!aH)return;const r=sc.getBoundingClientRect();const nx=(e.clientX-r.left)*(sc.width/r.width),ny=(e.clientY-r.top)*(sc.height/r.height);if(aH===1)p1={x:nx,y:ny};else p2={x:nx,y:ny};draw();});
    window.addEventListener('pointerup',()=>{if(aH)dec();aH=null;});

    function cap(){sc.width=v.videoWidth;sc.height=v.videoHeight;const ctx=sc.getContext('2d');ctx.drawImage(v,0,0);buf=ctx.getImageData(0,0,sc.width,sc.height);sc.style.display='block';isF=true;seed();draw();dec();}
    function seed(){const d=buf.data,W=sc.width,H=sc.height;let bY=H/2,mT=0;for(let y=Math.floor(H*0.2);y<H*0.8;y+=20){let t=0;for(let x=Math.floor(W*0.2);x<W*0.8;x+=4)if(d[(y*W+x)*4]<100)t++;if(t>mT){mT=t;bY=y;}}p1={x:W*0.15,y:bY};p2={x:W*0.85,y:bY};}
    function draw(){const ctx=sc.getContext('2d');ctx.putImageData(buf,0,0);const ang=Math.atan2(p2.y-p1.y,p2.x-p1.x),dist=Math.hypot(p2.x-p1.x,p2.y-p1.y),bH=sc.height*0.08;ctx.save();ctx.translate(p1.x,p1.y);ctx.rotate(ang);ctx.strokeStyle="rgba(255,0,0,0.4)";ctx.lineWidth=2;ctx.strokeRect(0,-bH/2,dist,bH);ctx.strokeStyle="#00ff00";ctx.lineWidth=1;for(let i=1;i<7;i++){ctx.beginPath();ctx.moveTo(0,-bH/2+(i*(bH/7)));ctx.lineTo(dist,-bH/2+(i*(bH/7)));ctx.stroke();}ctx.restore();[p1,p2].forEach(p=>{ctx.fillStyle="white";ctx.strokeStyle="#00ff00";ctx.lineWidth=4;ctx.beginPath();ctx.arc(p.x,p.y,25,0,7);ctx.fill();ctx.stroke();});}
    function dec(){
        const ang=Math.atan2(p2.y-p1.y,p2.x-p1.x),dist=Math.hypot(p2.x-p1.x,p2.y-p1.y),bH=sc.height*0.08,sH=bH/7,W=sc.width,d=buf.data;
        let bars=[],inB=false,tS=0;for(let i=0;i<dist;i++){const px=Math.floor(p1.x+Math.cos(ang)*i),py=Math.floor(p1.y+Math.sin(ang)*i);if(d[(py*W+px)*4]<115){if(!inB){inB=true;tS=i;}}else if(inB){inB=false;if(i-tS>1)bars.push({m:(tS+i)/2});}}
        const fadt=bars.map(b=>{let z=new Array(7).fill(false);for(let s=0;s<7;s++){const off=(-bH/2+(s*sH))+(sH/2),px=Math.floor(p1.x+Math.cos(ang)*b.m-Math.sin(ang)*off),py=Math.floor(p1.y+Math.sin(ang)*b.m+Math.cos(ang)*off);if(d[(py*W+px)*4]<115)z[s]=true;}const A=z[0]||z[1],D=z[5]||z[6];return A&&D?'F':A?'A':D?'D':'T';}).join('');
        fd.innerText=fadt||"---";st.innerText=`v3.1 | ${fadt.length} Bars`;st.style.color=fadt.length===65?"#00ff00":"#ff4444";
    }

    function processFADT() {
        const fadt = fd.innerText; if(fadt.length!==65) return alert("Need 65 bars.");
        const res = decode_chars_to_info(fadt);
        let html = '';
        if(res.message) html = `<div style="color:red;text-align:center">${res.message}</div>`;
        else {
            const fields = [["Barcode ID", res.barcode_id], ["Service Type", res.service_type], ["Mailer ID", res.mailer_id], ["Serial No.", res.serial_num], ["Routing", res.routing]];
            fields.forEach(([l,v])=> html+=`<div class="data-row"><span class="data-label">${l}</span><span class="data-val">${v}</span></div>`);
        }
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function resetScanner(){sc.style.display='none';isF=false;fd.innerText="---";st.innerText="v3.1 | Ready";}
    window.onload=start;
</script>
</body>
</html>